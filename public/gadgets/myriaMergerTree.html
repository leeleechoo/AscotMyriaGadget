<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Myria Merger Tree</title>
  <!-- ASCOT Basic Style Sheets -->
  <link href="/css/reset.css" rel="stylesheet" type="text/css">
  <link href="/css/text.css" rel="stylesheet" type="text/css"> 
  <link href="/css/widgets.css" rel="stylesheet" type="text/css"> 
  <link href="/css/mergerTreeStyle.css" rel="stylesheet" type="text/css"> 
  <style type="text/css">
  #queryEditor, #queryButton {
    display: block;
  }
  #queryHeader, #queryEditor, #queryButton {
    margin: 8px;
  }
  #queryEditor {
    margin: 0px;
    min-height: 250px;
    width: 100%;
    box-sizing: border-box;
    overflow: auto;
  }
  #outputContent {
    overflow: auto;
    height: 450px;
  }
  #outputHeader, #outputContent, div[id*="timestep"] {
    margin: 8px;
  }
  .sectionHeader {
    font-size: 24px;
    font-weight: bold;
  }
  .subsecHeader {
    font-size: 18px;
  }
  #options {
    display: block;
  }
  #progenitorResult {
    height: 960px;
    width: 960px;
  }
  #mergerTreeResult {
    height: 1300px;
    width: 960px;
  }
  #custom {
    clear: both;
  }
  .selection {
    display: block;
    margin-bottom: 10px;
  }
  .selection label {
    margin-right: 7px;
  }
  #outputContent table, #outputContent tr, #outputContent td, #outputContent th {
    border: 2px solid gray;
  }
  #outputContent th {
    text-align: center;
  }
  #outputContent th, #outputContent td {
    padding: 5px;
  }
  #customTableHeader {
    background-color: lightgray;
  }
  #customTableRow:hover{
    background-color: lightyellow;
  }
  #svgContent {
    display: inline-block;
  }
  .mergerTreePanel {
    display: inline-block;
  }
  #leftPanel {
    width: 1200px;
  }
  </style>
</head>
<body>
  <div id="content">
    <div id="mergerTree">
      <div id="mergerTreeOptions">
        <label>Group(s): </label>
        <input id="mergerTreeGroup"></input>
        <button id="mQueryButton" onclick="tryFormAndSendMergerTreeQuery()">Execute</button>
      </div>
      <div id="mergerTreeResult">
          <div class="subsecHeader">Result</div>
          <div id="leftPanel"> 
            <div class="mergerTreePanel">
              <h3>Mass</h3>
              <div id="massPanel">
              </div>
            </div>
            <div class="mergerTreePanel">
              <h3>Particle Count</h3>
              <div id="particlePanel">
              </div>
            </div>
          </div>
          <div id="svgContent"> 
          </div>
          <div id="mergerTreeResultDisplay">
          </div>
      </div>
    </div>
    <div id="progenitor">
      <div class="sectionHeader">Progenitor Query</div>
      <div id="options">
        <div id="timesteps">
          <div class="selection">
            <label> Progenitors from  </label>
            <select id="timestepsDrop" name="timespteps"></select>
            <label> that contributes to halo(s) </label>
            <select id="halosDrop" name="halos"></select>
          </div>
          <button id="proQueryButton" onclick="tryFormAndSendQuery()">Execute</button>
        </div>
        <div id="progenitorResult">
          <div class="subsecHeader">Result</div>
        </div>
      </div>
    </div>
    <div id="custom">
      <div class="sectionHeader">Custom Query</div>
      <div id="queryArea">
        <div id="queryHeader">Write your JSON query here</div>
        <textarea id="queryEditor"></textarea>
        <button id="queryButton" onclick="tryExecuteQuery()">Execute</button>
      </div>
      <div id="outputArea">
        <div id="outputHeader">Result</div>
        <hr>
        <div id="outputContent"></div>
      </div>
    </div>
  </div>
</body>
<script src="http://code.jquery.com/jquery-1.8.1.min.js" type="text/javascript"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="/util.js" type="text/javascript"></script>
<script type="text/javascript" src="/wcs.js"></script>
<script src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"></script>
<script src="../d3/interaction_collapse.js"></script>
<script type="text/javascript">

var MYRIA_QUERY_URL = "/myria/query";
var MYRIA_DATA_URL = "/myria/data";
var MYRIA_MQUERY_URL = "/myria/mquery";
var MYRIA_MDATA_URL = "/myria/mdata";

var SNAPSHOTS = [
'cosmo50cmb.256g2MbwK.00512',
'cosmo50cmb.256g2MbwK.00504',
'cosmo50cmb.256g2MbwK.00480',
'cosmo50cmb.256g2MbwK.00466',
'cosmo50cmb.256g2MbwK.00456',
'cosmo50cmb.256g2MbwK.00455',
'cosmo50cmb.256g2MbwK.00432',
'cosmo50cmb.256g2MbwK.00408',
'cosmo50cmb.256g2MbwK.00406',
'cosmo50cmb.256g2MbwK.00384',
'cosmo50cmb.256g2MbwK.00336',
'cosmo50cmb.256g2MbwK.00328',
'cosmo50cmb.256g2MbwK.00312',
'cosmo50cmb.256g2MbwK.00288',
'cosmo50cmb.256g2MbwK.00264',
'cosmo50cmb.256g2MbwK.00240',
'cosmo50cmb.256g2MbwK.00226',
'cosmo50cmb.256g2MbwK.00216',
'cosmo50cmb.256g2MbwK.00192',
'cosmo50cmb.256g2MbwK.00168',
'cosmo50cmb.256g2MbwK.00144',
'cosmo50cmb.256g2MbwK.00128',
'cosmo50cmb.256g2MbwK.00096',
'cosmo50cmb.256g2MbwK.00084',
'cosmo50cmb.256g2MbwK.00072',
'cosmo50cmb.256g2MbwK.00048',
'cosmo50cmb.256g2MbwK.00024'];

var GROUPS_OF_INTEREST = [
'All', 46, 89, 105, 113, 126, 163, 164, 165, 173, 174, 177, 178, 181, 182,
186, 187, 191, 193, 196, 199, 200, 202, 203, 204, 205, 206, 208, 209, 210,
212, 213, 214, 218, 219, 220, 221, 223, 225, 226, 227, 228, 229, 231, 232,
233, 234, 235, 237, 238, 239, 240, 242, 243, 244, 245, 246, 247, 248, 249,
250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264,
265, 266, 267, 268, 269, 270, 271, 272, 273, 275, 277, 278, 279, 280, 281,
283, 284, 285, 286, 287, 288, 289, 290, 291, 294, 295, 296, 297, 298, 299,
300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313, 314,
315, 316, 317, 318, 319, 320, 321, 322, 324, 325, 326, 327, 328, 329, 330,
331, 332, 333, 334, 335, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345,
347, 348, 349, 350, 352, 353, 354, 355, 356, 357, 358, 359, 360, 361, 363,
364, 367, 368, 370, 371, 372, 373, 374, 375, 376, 377, 378, 379, 380, 381,
383, 384, 385, 386, 387, 388, 389, 390, 391, 392, 393, 394, 396, 397, 398,
399, 400, 401, 402, 403, 404, 405, 406, 407, 408, 410, 411, 412, 413, 414,
415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 426, 427, 428, 429,
430, 431, 433, 434, 435, 436, 437, 438, 440, 441, 442, 443, 445, 446, 447,
448, 452, 453, 454, 455, 456, 457, 459, 460, 461, 462, 463, 465, 466, 468,
471, 472, 473, 475, 476, 478, 482, 483, 488, 490, 491, 493, 496, 499, 501,
502, 503, 506, 511, 512, 515, 523, 526, 528, 533, 536, 537, 543, 545, 550,
555, 559];

var diameter = 750,
format = d3.format(",d"),
color = d3.scale.category20c();

var bubble = d3.layout.pack()
.sort(null)
.size([diameter, diameter])
.padding(1.5);

var progenitorResultSvg = d3.select("#progenitorResult").append("svg")
.attr("width", diameter)
.attr("height", diameter)
.attr("class", "bubble");

var queryType = {
  PROGENITOR : 0,
  CUSTOM: 1,
  MERGER_TREE_Q1: 2,
  MERGER_TREE_Q2: 3
};

var selectedGroup = -1;

var setUp = function() {

  // Add check all button.

  // Add uncheck all button.
  // Get the timestep section to add timestep selection option to users.
  var timestepsSection = document.getElementById('timestepsDrop');
  for (var i = 0; i <= 26; i++) {
    var timestepId = 'timestep' + i;
    var wrapbox = document.createElement('option');
    wrapbox.setAttribute('id', timestepId);
    wrapbox.innerHTML = SNAPSHOTS[i];
    wrapbox.setAttribute('value', i);
    timestepsSection.appendChild(wrapbox);
  }
  // Populate halos dropbox.
  var halosDrop = document.getElementById("halosDrop");
  for (var i = 0; i < GROUPS_OF_INTEREST.length; i++) {
    var haloOption = document.createElement('option');
    var halo = GROUPS_OF_INTEREST[i];
    haloOption.innerHTML = halo;
    haloOption.setAttribute('value', halo);
    halosDrop.appendChild(haloOption);
  }
  // Append execute button.

  // Hide MergerTreePanel
  showMergerTreePanel(false);
};

gadget.init = function(callback){
  callback();
  setUp();
}

var showMergerTreePanel = function(show) {
  var panelElements = document.getElementsByClassName('mergerTreePanel');
  if (show) {
    for (var i = 0; i < panelElements.length; i++) {
      panelElements[i].style.display = "";
    }
  } else {
    for (var i = 0; i < panelElements.length; i++) {
      panelElements[i].style.display = "none";
    }
  }

};

var tryExecuteQuery = function() {
  $.post(MYRIA_QUERY_URL, {query: $("#queryEditor").val()}, function(res) {
    var queryId = res.query_id;
    var status = res.status;
    tryGetResult(queryId, queryType.CUSTOM);
  }, 'json'); 
};

var clearPreviousDisplay = function() {
  var svg = document.getElementsByTagName('svg')[0];
  while (svg.firstChild) {
    svg.removeChild(svg.firstChild);
  }
};

var displayResult = function(data) {
  clearPreviousDisplay();

  data = data.map(function(node){
    return {
      packageName: node.grp,
      className: node.grp,
      value: node.tot_mass,
      time: node.time,
      grp: node.grp,
      pgtr: node.pgtr
    }
  });
  var completeFormat = {
    name: "progenitor",
    children: data
  };
  var node = progenitorResultSvg.selectAll(".node")
  .data(bubble.nodes(completeFormat)
    .filter(function(d) { return !d.children; })
    )
  .enter().append("g")
  .attr("class", "node")
  .attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });

  node.append("title")
  .text(function(d) {
    return d.value; });

  node.append("circle")
  .attr("r", function(d) { return d.r; })
  .style("fill", function(d) { return color(d.grp); });


  node.append("text")
  .attr("dy", ".3em")
  .style("text-anchor", "middle")
  .text(function(d) {
    return (d.pgtr + '').substring(0, d.r / 3);
  });
};

d3.select(self.frameElement).style("height", diameter + "px");

var tryGetResult = function(queryId, queryTypeEnum) {
  // Keep enquiring for the query status until the status is success.

  switch(queryTypeEnum) {
    case queryType.MERGER_TREE_Q1:
      $.get(MYRIA_MQUERY_URL, {query: queryId}, function(res) {
        if (res.status != 'SUCCESS') {
          tryGetResult(queryId, queryTypeEnum);
        } else {
          var conditions = {
            group: selectedGroup,
            dataTable: "Cosmo50Links2",
            resultTable: "FilteredLinks2"
          };
          sendMergerTreeQuery(conditions, queryType.MERGER_TREE_Q2);
        }
      });
    break;
    case queryType.MERGER_TREE_Q2:
      $.get(MYRIA_MQUERY_URL, {query: queryId}, function(res) {
        if (res.status != 'SUCCESS') {
          tryGetResult(queryId, queryTypeEnum);
        } else {
            // Then get the result.
            $.get(MYRIA_MDATA_URL, {table: 'FilteredNodes2'}, getSecondMergerTreeQueryResult, 'json');
        }
      });
    break;
    default:
      $.get(MYRIA_QUERY_URL, {query: queryId}, function(res) {
        if (res.status != 'SUCCESS') {
          tryGetResult(queryId, queryTypeEnum);
        } else {
          // Then get the result.
          if (queryTypeEnum == queryType.CUSTOM) {
            $.get(MYRIA_DATA_URL, {table: 'result2'}, displayResultForCustomQuery, 'json');

          } else if (queryTypeEnum == queryType.PROGENITOR) {
            $.get(MYRIA_DATA_URL, {table: 'result2'}, displayResult, 'json');
          }
        }
      });
  }
};


var getSecondMergerTreeQueryResult = function(data) {
  $.get(MYRIA_MDATA_URL, {table: 'FilteredLinks2'},
    displayMergerTreeResult.bind(this, data), 'json');
}

var displayMergerTreeResult = function(data1, data2) {
  showMergerTreePanel(true);
  data2.sort(function(obj1, obj2) {
    return obj1.CurrentTime - obj2.CurrentTime});
  data1.sort(function(obj1, obj2) {
    return obj1.TimeStep - obj2.TimeStep;
  });
  displayMergerTree(data2, data1, selectedGroup);
};

var displayResultForCustomQuery = function(data) {
  clearPreviousCustomQueryDisplay();
  var customQueryResultSection = document.getElementById('outputContent');
  if (data.length == 0) {
    return;
  }
  var table = document.createElement('table');
  table.setAttribute('border', '1');
  var firstRow = data[0];
  var header = document.createElement('tr');
  header.setAttribute('id', 'customTableHeader');
  for (key in firstRow) {
    var th = document.createElement('th');
    th.innerHTML = key;
    header.appendChild(th);
  }
  table.appendChild(header);
  for (var i = 0; i < data.length; i++) {
    var row = document.createElement('tr');
    row.setAttribute('class', 'customTableRow');
    for (key in data[i]) {
      var td = document.createElement('td');
      td.innerHTML = data[i][key];
      row.appendChild(td);
    }
    table.appendChild(row);
  }
  customQueryResultSection.appendChild(table);
};

var clearPreviousCustomQueryDisplay = function() {
  var customQueryResultSection = document.getElementById('outputContent');
  while (customQueryResultSection.firstChild) {
    customQueryResultSection.removeChild(customQueryResultSection.firstChild);
  }
};

var sendMergerTreeQuery = function(conditions, queryType) {
  $.post(MYRIA_MQUERY_URL, conditions, function(res) {
    // Get the query id.
    var queryId = res.queryStatus.queryId;
    console.log('queryId ' + queryId);
    tryGetResult(queryId, queryType);
  }, 'json');
}

var tryFormAndSendMergerTreeQuery = function() {
  selectedGroup = document.getElementById('mergerTreeGroup').value;
  // if (!verifyMegerTreeGroupArgument(selectedGroup)) {
  //   showMergerTreeQueryError();
  //   return;
  // }
  var conditions = {
    group: selectedGroup,
    dataTable: "Cosmo50Nodes2",
    resultTable: "FilteredNodes2"
  }
  sendMergerTreeQuery(conditions, queryType.MERGER_TREE_Q1);
};

var tryFormAndSendQuery = function() {
  var conditions = 'potpro2_time=' + document.getElementById('timestepsDrop').value;
  var grpValue = document.getElementById('halosDrop').value;
  if (grpValue != 'All') {
    conditions += ' and potpro2_grp=' + grpValue;
  }
  var queryString = 
  {
    "fragments": [
    {
      "operators": [
      {
        "op_name": "Scan",
        "op_type": "DbQueryScan",
        "schema": {
          "column_names": [
          "time",
          "grp",
          "pgtr",
          "tot_mass"
          ],
          "column_types": [
          "INT_TYPE",
          "INT_TYPE",
          "INT_TYPE",
          "FLOAT_TYPE"
          ]
        },
        "sql": "SELECT * FROM [leelee#astro#progenitorallsplit2] WHERE " + conditions
      },
      {
        "arg_child":"Scan",
        "arg_overwrite_table":true,
        "op_name":"Insert",
        "op_type":"DbInsert",
        "relation_key":{
          "program_name":"astro",
          "relation_name":"result2",
          "user_name":"leelee"
        }
      }
      ]
    }
    ],
    "logical_ra": "result holds the temp result",
    "raw_datalog": "blah."
  };
  $.post(MYRIA_QUERY_URL, {query: JSON.stringify(queryString)}, function(res) {
    // Get the query id.
    var queryId = res.query_id;
    var status = res.status;
    tryGetResult(queryId, queryType.PROGENITOR);
  }, 'json');
};
</script>
</html>